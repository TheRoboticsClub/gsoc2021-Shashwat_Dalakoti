---
layout: post
title:  "Week 4"
date:   2021-06-30 02:30:50 +0530
categories: jekyll update
---

An important part of the exercise is to provide the user with relevant information and guides to train and fine tune their models in different frameworks.This would include everything from making the process of collecting data, preprocessing it and fine tuning with it on a pre-existing model architecture. Since the process of exporting models to ONNX format is different for different frameworks, including so under each framework's guide becomes necessary.

## PyTorch Guide

I have documented a guide for the PyTorch implementation. Please refer to it below for the detailed information.
* [**SSDMobilenet_PyTorch_FineTune**](https://github.com/TheRoboticsClub/gsoc2021-Shashwat_Dalakoti/blob/main/Fine_Tuning/PyTorch/SSDMobilenet_pytorch_FineTune.ipynb)

In short this is what the guide contains:

* Testing Pytorch based pre-trained Mobilenet_SSD model to detect humans and converting it into the ONNX format.
* Fine tuning the model on custom dataset for a specific class of object from open-image dataset.
* Testing and inferring on the fine tuned model.
* Converting the Fine Tuned model to ONNX format.

#### Challenges and errors faced

* Collecting all the relevant information to make the process of fine tuning as easy as possible was a challenge in itself.

* The ONNX conversion code used in the guide loaded the fine tuned state dictionary to the model architecture in a cpu specific format, whereas I was using a GPU environment on colab. This resulted in the following error:
```
expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu!
```
This was solved buy moving the model and the dummy input to device type CUDA
```
net.to("cuda")
dummy_input = torch.Variable(1,3,300,300).to("cuda")
```

* The ONNX conversion code also gave a strange error while conversion
```
IndexError: Input 475 is undefined
```
Debugging this was strange as the error did not display any other information. Checking the error traceback made me realise that this occurred during the `onnx_graph_to_caffe2_net(model)` function. I analyzed the code and realized there was no need for this function in my implementation, so I got rid of it. Everything worked pretty fine after that.

* * *
<br/>

## TensorFlow Guide

Luckily, there exists a quite famous object detection API for TensorFlow models called the TensorFlow Object Detection API. It is an open source framework built on top of TensorFlow that makes it easy to construct, train and deploy object detection models. Since it is so popular and widely used, I didn't have to write down a personalized guide as I did for the PyTorch models. Apart from their official GitHub page [**here**](https://github.com/tensorflow/models/tree/master/research/object_detection), which you can refer to for a more detailed look-over, I went through some good blogs and articles explaining it's use to fine tune an object detection model. Here's the one I found most useful:

* [Training a TensorFlow MobileNet Object Detection Model with a Custom Dataset](https://blog.roboflow.com/training-a-tensorflow-object-detection-model-with-a-custom-dataset/)

This guide walks you through using the TensorFlow object detection API to train a MobileNet Single Shot Detector (v2) to your own dataset. Here's the complete Jupyter notebook guide for the above article:

* [Roboflow-tensorflow-object-detection-mobilenet-colab.ipynb](https://colab.research.google.com/drive/1wTMIrJhYsQdq_u7ROOkf0Lu_fsX5Mu8a)

I strongly suggest you to go through it as apart from the usage of the TensorFlow object detection API, it also explains and makes the entire process of preprocessing the training data very easy and automated using Roboflow, which handles the images, annotations, TFRecord file and label_map generation. 


